# OCRエラーとアプリ構成の問題

オーナー: aseri
タグ: ナレッジ
最終更新日時: 2025年11月20日 15:46

ここでは、会議録「【sdc】AI駆動開発打合せ（第6回）.txt」に出てくる **菅野さん（菅野聖人さん）が健康診断結果OCRアプリに対して行った指摘** を、文脈ごとに丁寧に整理してまとめます。会議録の具体的な発言をもとに、意味合いと意図がわかるように解説します。

[【sdc】AI駆動開発打合せ（第6回）.txt](%E3%80%90sdc%E3%80%91AI%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA%E6%89%93%E5%90%88%E3%81%9B%EF%BC%88%E7%AC%AC6%E5%9B%9E%EF%BC%89.txt)

---

# 菅野さんが行った主な指摘・助言の詳細

## ■ 1. **「OCR処理エラーは API がデプロイされていない可能性が高い」**

OCR処理を実行するとエラーになる件について、菅野さんは次のように指摘しています。

> 「多分、API がデプロイされてないって感じですよね。フロントだけで。」
> 

つまり、

- フロントエンド（UI）はデプロイされている
- しかし OCR を実行するバックエンドの API が稼働していない
- そのためフロントから API を叩いても応答が返らずエラーになる
    
    という構図を想定したコメントです。
    

これは、実際に世利さんも原因をつかみかねていたため、その可能性を指摘して問題の切り分けを助けた形になります。

---

## ■ 2. **「OCR処理は TypeScript で書かれているのでフロント側に移せる可能性もある」**

OCRの実装に関して、菅野さんは次のように述べています。

> 「OCR処理、多分これバックエンドで書かれているような感じがするんで…タイプスクリプトですもんね。両方。」
> 
> 
> 「もしかしたらフロントに移しちゃってもいけるのかもしれない」
> 

この含意は次のとおりです。

- OCRロジックが TypeScript で書かれている → フロントでも動く可能性がある
- バックエンドのデプロイ問題を回避するため、**フロント側で完結させる**選択肢がある
- ただし後述のようにライブラリ依存で動かない可能性もある

バックエンドがボトルネックになる場合、フロント移行がスピードアップにつながるという観点の指摘です。

---

## ■ 3. **「Supabase にバックエンドを置くのも簡単で良い」**

構成の代替案として、菅野さんは Supabase の利用も推奨しています。

> 「スパベースの設定は意外と楽なので、API をスパベースで作ってフロントにつなぐと良いかもしれない」
> 

これは「バックエンドのホスティング問題で苦戦するなら、Supabase の機能を使えば簡単に API が作れる」というアドバイスです。

---

## ■ 4. **「ライブラリによってはフロントでは動かないものもある」**

フロント側に処理を寄せる案に対して、菅野さんはリスクも明確にしています。

> 「OCRとかのライブラリでサーバー側でしか動かないものを使ってるとフロントでは動かないこともある」
> 

つまり、

- 軽いロジックならフロントで動く
- でも、重いOCRやネイティブ依存の処理はフロント(Javascript)では動かない
- ライブラリの対応状況を調べてから判断する必要がある
    
    という重要な技術的注意です。
    

---

## ■ 5. **「まずは動く最小構成（MVP）を公開してフィードバックを得るべき」**

世利さんが説明した「まずデプロイしてユーザーに触ってもらう」という方針に対し、菅野さんは肯定的に反応しています。

> 「うんうんうんうん（賛同）」
> 
> 
> ※発言は短いですが、前後の文脈から方針の妥当性をサポートする意図が読み取れます。
> 

---

# ■ まとめ：菅野さんの指摘の全体像

菅野さんのコメントは、単なる不具合指摘ではなく、**アプリ構成の改善・デプロイの安定化・開発効率向上まで含んだ総合的な技術助言**になっています。

特に重要なのは次の4点です。

1. **OCRエラーの原因は「APIがデプロイされていない可能性」が高い**
2. **OCR処理はTypeScriptなので、フロントで動かせば構成がシンプルになる可能性がある**
3. **Supabase を使えばバックエンド構築が容易で、デプロイ問題も避けられる**
4. **ただし OCR ライブラリによってはフロント非対応の可能性があるため要確認**

これにより、世利さんが抱えていた不具合や構成の悩みに対して、複数の選択肢とリスクが整理された形になっています。

# 指摘を踏まえた推奨アーキテクチャ案／次にやるべき技術検証ポイントのリスト

---

## 1. 前提のおさらい（要件・状況）

会議メモから読み取れる要件・状況はざっくりこんな感じです：

- 紙の健康診断結果をアップロードして **OCR → 編集可能な形式に変換** するツール
- OCR結果は **画面で編集**できる
- **元画像とOCR結果を並べて照合・編集しやすくするUI** を追加予定
- OCR結果は **CSV / Excel 形式でダウンロード**可能
- すでに最低限の機能はあり、**まずはOCRだけ動く版をデプロイしてユーザーに触ってもらい、フィードバックをもらって機能拡張**する方針
- 現状、デプロイ後に **OCR処理エラー** が発生しており、ログを見ながら原因調査中。菅野さんは「APIがデプロイされていない可能性」を指摘
- OCR処理は TypeScript で書かれており、**フロント側に寄せることも可能かもしれない**という話
- 別案として、**Supabase でAPIを作ると設定が楽**という助言あり
- ただし、**OCRライブラリがサーバー専用の可能性**もあるので、フロント移行には注意

---

## 2. 菅野さんの指摘を踏まえた「推奨アーキテクチャ案」

ここでは「MVP向け」と「本番運用を見据えた構成」を分けて提案します。

### 2-1. ステップ1：MVP向けのシンプル構成

**目的**：

まずは「OCRがちゃんと動く」「ユーザーからフィードバックがもらえる」ところまで最短距離で行く構成。

**構成イメージ：**

- フロントエンド：
    - Next.js / React（既存のTSフロントを継続使用）
    - 画面機能：アップロード、OCR結果表示、画像との比較、簡易編集、CSV/Excelダウンロード
- バックエンド（できれば最小限）：
    - パターンA：既存のOCR API をそのままシンプルに1エンドポイント化してデプロイ
    - パターンB：Supabase Edge Functions で `POST /ocr` のようなAPIを1本用意
    - ストレージ：
        - 入力画像…Supabase Storage など
        - OCR結果…最初はDB保存せず、レスポンスとダウンロード用ファイル生成だけでもOK（まずはフロー検証優先）

**ポイント：**

- 「APIがデプロイされていないっぽい」問題を避けるため、
    - フロントと同じリポジトリ内でAPIを管理するか
    - Supabase などで「ここがOCR API」という場所を明示する
- MVPでは「ユーザーが1件アップロード → OCR → 編集 → ダウンロード」までが安定して動くことに集中。
- ログをしっかり出して、OCRエラーの原因をすぐ追えるようにする。

---

### 2-2. ステップ2：本番運用を見据えた構成（おすすめフル構成）

MVPでフィードバックが得られたあと、「本番運用」を想定した構成案です。

### (1) 全体構成

- **フロントエンド**
    - Next.js / React（TypeScript）
    - 機能：
        - 画像アップロード画面
        - OCR結果＋元画像の比較編集画面
        - 履歴一覧画面（将来的に）
        - CSV/Excelダウンロード
- **バックエンド / API**
    - Supabase Edge Functions もしくはサーバーレス（Cloud Functions等）で実装
    - エンドポイント例：
        - `POST /ocr`：画像を受け取り、OCRを実行してテキスト＋構造化データを返す
        - `GET /results/:id`：過去のOCR結果取得
        - `POST /results/:id/export`：CSV/Excel生成
- **データストア**
    - Supabase Postgres：
        - 検診票メタ情報（ユーザー、日付、検査種別など）
        - OCR結果（JSON形式で保持すると再利用しやすい）
    - Supabase Storage：
        - 元画像（スキャンした健康診断票）
        - 生成済みCSV/Excel（キャッシュ用）
- **認証**
    - Supabase Auth などで社内ユーザー限定利用にする（健康情報なのでここはかなり重要）

### (2) 「フロントに移すか？」の扱い

菅野さんの指摘どおり、

- TypeScriptで書いているなら「フロントにOCRロジックを持ってくる」ことも候補
- ただし、OCRライブラリがブラウザ非対応の場合はアウト

なのでアーキテクチャ的には：

- **基本方針**：OCRはサーバー側（Supabase Edge Functions など）で実行
- **例外**：
    - 軽量なブラウザ対応OCRライブラリ＋小規模運用であれば、
        - 「フロントでOCR → 結果だけAPIに保存」という構成もあり

トレードオフとしては：

- サーバー側OCR：
    - 利点：パフォーマンス・ライブラリの選択肢が広い、機密情報の扱いも一元管理できる
    - 欠点：インフラ管理が多少増える
- フロント側OCR：
    - 利点：APIデプロイが不要になり構成が単純になる
    - 欠点：ライブラリ制約が大きい・端末スペックに依存・セキュリティ/ログの一元管理がしづらい

---

## 3. 次にやるべき「技術検証ポイント」のリスト

ここからが実務で効くチェックリストです。上から順に潰していくと、わりとスムーズに進みます。

### 3-1. OCRライブラリの実行環境確認

1. 現在使用中のOCRライブラリが
    - ブラウザ（フロント）で動くのか
    - Node.js / サーバー専用なのか
        
        をドキュメントで確認する。
        
2. ブラウザ対応なら簡単なPoCを作り、フロント単体での実行可否・速度を測る。
3. サーバー専用なら、Supabase Edge Functions などサーバー側ランタイムで動くか確認。

### 3-2. パフォーマンスと精度の検証

1. 代表的な健康診断票を数パターン用意し、
    - 処理時間（秒）
    - 認識精度（項目名・数値・単位）
        
        を測定。
        
2. A4×1〜2枚を想定したとき、ユーザーの待ち時間が許容範囲か確認（目安：数秒〜十数秒以内）。

### 3-3. API構成とデプロイの安定性

1. 「APIがデプロイされていないっぽい問題」を再現し、
    - フロント→API のURL
    - 認証（APIキー、ロール）
    - CORS設定
        
        を一通りチェック。
        
2. Supabaseで `POST /ocr` 相当のEdge Functionを1本実装してデプロイし、
    - ローカル→ステージング→本番 のデプロイ手順をドキュメント化。
3. APIのログ出力を整備し、OCRエラー発生時に
    - 入力ファイルID
    - 実行したライブラリバージョン
    - エラーメッセージ
        
        を追跡できるようにする。
        

### 3-4. CSV / Excel エクスポート仕様の固め

1. 担当者が求める列構成（検査項目名、数値、基準値、判定など）を確認。
2. OCR結果 → 中間JSON → CSV/Excel という変換処理を試作し、
    - 日本語・数値・記号（+ / - など）の扱い
    - 文字コード・Excelでの表示崩れ
        
        を確認。
        

### 3-5. 画像との突き合わせUI（編集性）の検証

1. 「左に元画像、右にテキスト」というような2ペインUIを試作し、
    - スクロール同期
    - 項目番号の表示（どの項目がどこを見ているか）
        
        がどこまで自動化できるか検証。
        
2. レイアウト崩れが激しい票でも、人間が見て編集しやすいかを担当者に触ってもらって確認。

### 3-6. ユーザーフィードバックを得るためのMVP公開フロー

1. 「OCRのみ実装版」をステージング環境にデプロイし、
    - 一部の担当者に触ってもらう
    - フィードバック回収フォーム（簡単なアンケートでも可）を用意。
2. フィードバックに基づいて
    - 優先度の高い改善（UI、精度、ダウンロード形式など）
        
        をバックログ化して次スプリントのネタにする。
        

---

## まとめ

菅野さんの指摘を整理すると：

- 「今のエラーは多分API周りだよ」
- 「TSで書いてるならフロントに寄せる選択肢もある」
- 「でもライブラリ的に結局サーバー側に置く方が安全かもしれない」
- 「SupabaseでAPI切るとだいぶ楽になる」

というメッセージなので、

1. **まずは Supabase などでOCR APIをシンプルに1本立てるMVP構成**で
2. **OCRライブラリの実行環境・パフォーマンスを検証しつつ**
3. **ユーザーに触ってもらって改善ポイントを洗い出す**

というのが、現実的かつ筋の良い進め方になります。

# Codexによる実際のアプリケーション構成の分析

- このプロジェクトの構成を見る限り、「構成のせいでVercelではそのままではOCRが動かない」状態になっている可能性が高いです。上司のアドバイスを、このリポジトリの実際の構成に当てはめて整理します。

今の構成（ざっくり）

- frontend/：Vite + React のPWA（「Progressive Web Apps」の略で、WebサイトやWebアプリをネイティブアプリのように使える技術を指します）
- frontend/src/api/healthReportApi.ts から processHealthReport を呼ぶときにAPI_BASE_URL（VITE_API_URL or /api）に対して POST /process-health-report を叩いています（57行目：「const response = await fetch(`${API_BASE_URL}/process-health-report, {`」）。
- backend/：Express サーバー（backend/src/index.ts）で、
    - POST /process-health-report（health-report.routes.ts → health-report.controller.ts）を受け、multer （Node.jsのためのミドルウェアで、主にHTTPのmultipart/form-data形式で送信されるファイルのアップロードを簡単に処理するライブラリ）で images を受信して、backend/src/services/llm.service.ts から OpenAI の GPT-4o を呼び出して「OCR＋構造化」（169行目： `const response = await openai.chat.completions.create({`）をしています。
- ローカル/コンテナでは nginx/nginx.conf で
    - / → フロント (frontend:5173)
    - /api/ → バックエンド (backend:8080) にプロキシして動かす前提です。

**Vercel にはこの Nginx は載っていませんし、Express サーバーも「そのまま」では動きません。**

———

### 1. 「APIがデプロイされていない可能性」について

この指摘はほぼ当たっています。

- フロントは Vite なので、Vercel にデプロイすると「静的サイト or SSG」として frontend だけが動いている状態になりがちです。
- 一方、バックエンドは app.listen(PORT) する純粋な Express アプリで、Vercel の「Serverless Function / Edge Function」としては定義されていません（/api/*.ts などもない、vercel.json もない）。
- その結果：
    - フロントから見れば https://<vercel-domain>/api/process-health-report に POST しているつもりですが、
    - Vercel 側にはそのパスを処理する関数がないため、404 か、ルーティング・ビルド設定次第で 500 が返っている可能性が高いです。

つまり「構成上、バックエンドAPIがVercel側に存在しない（もしくは正しくルーティングされていない）」ことが、500の主因になり得ます。

解決するには、ざっくり次のどれかが必要です。

- バックエンドを別ホスティング（Railway, Render, [Fly.io](http://fly.io/), 自前VPSなど）にデプロイし、VercelのフロントからそのURLに向けて叩く（VITE_API_URL をそのURLにする）。
- Express をやめて、Vercelの api/ ルート（あるいは Edge Functions）として書き直す。
- Nginx込みのDockerイメージをそのまま動かせる環境にデプロイする（Vercel ではなく別サービス）。

———

### 2. 「TypeScriptだからフロントで動かせばシンプルになるか？」について

結論：このプロジェクトのOCR処理（正確には OpenAI への画像＋プロンプト送信）は、今のままフロントだけで完結させるのは現実的ではありません。

理由：

- OCRロジックは backend/src/services/llm.service.ts で、
    - Node版の OpenAI クライアント (import OpenAI from 'openai') を使っており、
    - OPENAI_API_KEY という「サーバー側秘密キー」を必須にしています。
- ブラウザから直接 OpenAI API を呼ぶと、
    - APIキーをJSバンドルに含めることになり、完全に漏洩します（NG）。
    - Node向けクライアントはブラウザではそのまま動きません。
- 画像はバックエンドで multer によって file.buffer として受け取り、Base64にして OpenAI に渡しています。この「画像→Base64→OpenAI」
の処理自体はブラウザでもできますが、「キーを隠す」ために結局どこかサーバーが必要になります。

したがって

- TypeScriptで書いてあること自体はフロント移行を容易にしますが、
- 「OpenAIの秘密鍵を隠す必要がある」「Node向けクライアントを使っている」という制約のせいで、完全フロントのみ構成にするのは安全面で難しいです。

やるとしたら：

- ブラウザ側は単なる画像アップロード＋UIだけにして、
- OpenAIに問い合わせる部分だけを「サーバーレス関数（Vercel Functions / Edge Functions / Supabase Edge Functions など）」として残
す、という形になります。

———

### 3. 「Supabase を使えばバックエンド構築が容易で、デプロイ問題も避けられるか？」

このリポジトリには現時点で Supabase 関連コードはありません（DBも使っていない）。
Supabaseを使うとしたら、主に次の用途になります。

- Postgres + 認証 + ストレージ + Edge Functions などをまとめて提供してくれる。
- Edge Function を TypeScript で書いて、そこで今の extractHealthReportData 相当の処理を行い、フロントから呼ぶ。

つまり：

- 「バックエンドAPIそのもののホスティング」を Supabase に任せることで、Nodeサーバー運用・Nginx のようなリバースプロキシ設定を自分でやらずに済む、という意味では「デプロイ問題を避ける/単純化する」方向性としては妥当です。

ただし、

- どのみち「OpenAIを呼び出すサーバー側ロジック」はどこかに必要で、その候補が「今のExpressサーバー」か「VercelのFunction」か「Supabase Edge Function」か、という違いです。
- Supabaseは「簡単になる可能性はある」が、「魔法のようにフロントだけで完結させてくれるもの」ではありません。

———

### 4. 「OCRライブラリがフロント非対応の可能性」について

ここでの「OCRライブラリ」は、厳密には

- 画像→テキストの古典的OCRライブラリ（Tesseractなど）ではなく、
- OpenAI GPT-4o の Vision機能を使って「画像を見て構造化JSONを返してもらう」実装です（llm.service.ts を参照）。

この構成の重要ポイント：

- 使用しているのは「OpenAIのNodeクライアント + HTTP API」なので、フロントから直接使うこと自体は技術的には可能ですが、APIキーを隠せないため実運用では非現実的です。
- また、このプロジェクトでは Node 環境前提で書かれている（multer、Buffer、express 等）ため、そのままブラウザには持ち込めません。

したがって上司のコメントどおり、

- 「今使っているやり方（OpenAI Node SDK）はフロントでは使えない／安全に使えない」
- 「もしブラウザ対応のOCRライブラリ（例：Tesseract.jsなど）に切り替えるなら“本当にフロントだけ”で完結させることも可能だが、性能・コスト・精度などを再検討する必要がある」

という状況です。

———

### まとめ：この構成が原因でOCRが動いていないか？

はい、構成上の問題で Vercel デプロイ時に OCR が 500 を返している可能性が非常に高いです。

- 現在の OCR は「フロント（Vite）」＋「バックエンド（Express + OpenAI）」＋「ローカルではNginxで結合」という三層構成。
- Vercel には Nginx も Express もそのまま載っておらず、/api/process-health-report を処理するエンドポイントが存在していない状態と推測されます。
- TypeScriptだからといってフロントだけに移せるわけではなく、OpenAIの秘密鍵の扱いとNode依存がネックです。
- Supabase は「バックエンドをもっとマネージドな形で持つ」選択肢としてはありですが、OCRを完全にフロント化するものではありません。

———

### 方針に合わせたより具体的な手順

- A: Express バックエンドを別ホスティングにデプロイして、Vercelフロントから呼ぶ構成で行く。
- B: extractHealthReportData 周りを Vercel の Serverless Function / Edge Function に移植する。
- C: Supabase Edge Functions に移植して、フロントから Supabase を叩く構成にする。
- D: いっそ OpenAI ではなくブラウザ対応OCRライブラリ（Tesseract.jsなど）に切り替えて、完全フロント構成に再設計する。