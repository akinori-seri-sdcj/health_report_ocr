# 健診OCR ユーザーズマニュアル

最終更新: 2025-11-07

## 1. アプリ概要
- 健診結果（紙の検査結果票など）の画像から、必要な項目をOCRおよびLLMで抽出し、画面で確認・編集してからExcel/CSVにエクスポートできるPWA（ブラウザアプリ）です。
- スマートフォン/PCのブラウザから利用でき、PWAとしてホーム画面に追加することでアプリのように使えます。

## 2. 対象読者
- 健診結果のデータ化を行う担当者
- 画像撮影〜OCR〜結果の確認・修正〜エクスポートまでを実施する一般ユーザー

## 3. 動作環境
- 対応ブラウザ: 最新版の Google Chrome を推奨（Edge/Safari/Firefox でも基本動作しますが、日付入力のピッカー表示など一部挙動が異なる場合があります）
- ネットワーク: OCR/LLM機能のためインターネット接続が必要
- 端末: PC/タブレット/スマートフォン（カメラ機能を利用可能）

## 4. セットアップ（管理者向け）
開発/検証環境での起動方法です。社内で提供された既存環境がある場合は、この節は不要です。

### 4.1 バックエンド
1) 依存関係のインストール
- `backend` ディレクトリで以下を実行
```
npm ci
```
2) 設定
- `backend/.env.example` を `backend/.env` にコピーし、以下を設定
  - `OPENAI_API_KEY`（必須）: 利用するOpenAI APIキー
  - `PORT`（任意）: 既定は `8080`
3) 起動
```
npm run dev
```
- ヘルスチェック: `http://localhost:8080/health`

### 4.2 フロントエンド
1) 依存関係のインストール
- `frontend` ディレクトリで以下を実行
```
npm ci
```
2) 設定
- `frontend/.env.example` を参考に `frontend/.env` を用意
  - 開発では `VITE_API_URL=/api` を推奨（Viteのプロキシ経由）
3) 起動
```
npm run dev
```
- ブラウザで `http://localhost:5173` を開きます

4) APIプロキシ（開発時）
- フロントから `/api/*` へのリクエストは、バックエンドへ転送されます
- バックエンドのポートを変更した場合は `frontend/vite.config.ts` の `server.proxy` を合わせて更新してください

## 5. 画面と操作

### 5.1 カメラ/アップロード画面（「画像をアップロード」）
- 画像の追加
  - 右上の「画像を追加」ボタンから、端末のカメラ起動またはライブラリ選択で画像を取り込みます
  - 取り込んだ画像はサムネイルで一覧表示されます
- 画像パネルの表示切り替え
  - 画面上部のトグルで、画像パネルの表示/非表示を切り替えできます
- 注意
  - 文字が鮮明で、傾き/影/反射の少ない画像ほどOCR精度が向上します

### 5.2 確認・編集画面
- OCRの開始
  - 画像を追加後、「OCR処理を開始」ボタンを押します
  - 進行中は上部に進行中の表示が出ます
- 結果の確認/編集
  - 患者情報（氏名・受診日）と検査結果一覧が表示されます
  - 各セルは直接編集できます（白背景・黒文字で可読性を確保）
  - 受診日: 入力欄右側のカレンダーアイコンをクリックして日付ピッカーで選択できます（対応ブラウザではネイティブピッカーが開きます）
- 行の削除
  - 検査結果の行右端の「削除」ボタンで、対象行を削除できます
- エラー表示
  - APIエラー等が発生した場合は、画面上部にエラーメッセージが表示されます

### 5.3 エクスポート（Excel/CSV）
- エクスポートボタンから、出力形式（Excel/CSV）や対象（全件/選択/フィルタ済み）を選択して出力できます
- CSVの文字コードはUTF-8/Shift_JISを選択可能です（要件に応じて選択）
- Excel出力は `exceljs` を利用しています

## 6. 設定項目

### 6.1 フロントエンド（環境変数）
- `VITE_API_URL`: APIベースURL
  - 例: `/api`（推奨）, `http://localhost:8080`
- その他PWA関連設定は `frontend/vite.config.ts` を参照

### 6.2 バックエンド（環境変数）
- `OPENAI_API_KEY`（必須）: LLM呼び出しに利用
- `PORT`（任意）: 既定は `8080`
- `CORS_ORIGIN`（任意）: 本番時の許可オリジン

## 7. よくある質問（FAQ）
- Q. 画像をアップロードしてもOCRが動きません
  - A. バックエンドが起動しているか、`/api` が正しくプロキシ/接続されているかをご確認ください
- Q. 404エラーになります
  - A. 開発時は `http://localhost:5173/api/health` が200を返すか確認してください。返らない場合はViteのプロキシ設定を見直してください
- Q. 文字化けが表示されます
  - A. ブラウザをリロードしてください。解消しない場合は、キャッシュ（PWAのService Worker含む）をクリアした上で再度お試しください
- Q. 日付の選択方法が分かりません
  - A. 入力欄右側のカレンダーアイコンをクリックすると日付ピッカーが開きます

## 8. セキュリティ/プライバシー
- 取り扱う画像には個人情報が含まれます。管理者指示に従い、適切に保管/破棄してください
- ネットワーク経由でOCR/LLMに送信されるため、社内ポリシーに準拠した運用が必要です

## 9. PWAとしての利用
- Chromeのアドレスバーから「インストール」または「ホーム画面に追加」を選択すると、PWAとしてインストールできます
- オフライン時は一部機能が制限されます（OCR/LLM処理はオンライン必須）

## 10. トラブルシューティング（簡易）
- ブラウザをリロード/キャッシュクリア
- `http://localhost:<API_PORT>/health` が200か確認
- `http://localhost:5173/api/health` が200か確認
- バックエンドのAPIキー（`OPENAI_API_KEY`）設定を再確認
- ポート競合（`8080`など）がないか確認

---

本マニュアルに記載の操作で解決しない場合は、管理者または開発担当までお問い合わせください。
