# Feature Specification: API Routes配信とViteフロント統合デプロイ

**Feature Branch**: `001-vite-ocr-deploy`  
**Created**: 2025-12-03  
**Status**: Draft  
**Input**: User description: "API Routesへ移行したOCR処理を既存のVite + Reactのフロントエンド構成の画面から呼び出せるようデプロイできる構成にうするためにコードやプロジェクト構成を変更する"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - フロントから同一ドメインAPIを利用 (Priority: P1)

フロント画面利用者として、同じドメイン配下でOCR APIを呼び出し、追加設定なくアップロードと結果取得を完了したい。

**Why this priority**: 最終ユーザーの業務価値に直結し、デプロイ構成変更の主目的だから。

**Independent Test**: UIから1枚の画像を選択して送信し、APIレスポンスが返るまでを単体で確認できる。

**Acceptance Scenarios**:

1. **Given** フロント画面が `/ui/` で配信されている, **When** 画像を選択して送信する, **Then** 同一ドメインのOCR APIが呼ばれ結果が表示される
2. **Given** OCR APIがエラーを返す, **When** フロントから送信する, **Then** 利用者は原因を特定できるメッセージを受け取る

---

### User Story 2 - デプロイ後の健全性確認 (Priority: P2)

運用者として、デプロイ後にヘルスチェック経由でOCR APIの稼働と設定が正しいかをすぐ確認したい。

**Why this priority**: デプロイ構成変更後の不具合を素早く検知し、ユーザー影響を最小化するため。

**Independent Test**: ヘルスチェックエンドポイントを単体で呼び、設定値・稼働状態を確認できる。

**Acceptance Scenarios**:

1. **Given** デプロイ直後, **When** ヘルスチェックを呼び出す, **Then** ステータス・必要な設定状態が判別できるレスポンスが返る

---

### User Story 3 - 単一ビルドで両方を提供 (Priority: P3)

開発・運用担当として、単一のビルド／デプロイ手順でフロントとOCR APIを同梱し、追加の手動コピーや設定を不要にしたい。

**Why this priority**: 作業工数とヒューマンエラーを削減し、再現性のあるデリバリーを確保するため。

**Independent Test**: 定義されたビルドコマンドのみで成果物が生成され、デプロイ後に `/ui/` と `/api/ocr` の両方が動作することを確認できる。

**Acceptance Scenarios**:

1. **Given** 用意されたビルドコマンド, **When** コマンドを実行する, **Then** フロント配信とOCR APIが同一成果物に含まれる
2. **Given** 新しい環境へデプロイ, **When** 追加の手動コピーを行わない, **Then** `/ui/` と `/api/ocr` がアクセス可能

---

### Edge Cases

- フロント配信パス(`/ui/`)配下でのリロードやディープリンク時に、期待通り画面が表示されるか。
- OCR APIがダウンまたは環境変数未設定の場合、フロントで適切なエラー表示と再試行案内が行われるか。
- 画像サイズや枚数の上限超過時に、API・フロント双方で明確なバリデーションメッセージが返るか。
- デプロイ設定が異なる環境（プレビュー／本番）で、フロントのAPI呼び先が誤らないか。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: デプロイ成果物は同一ドメインでフロント画面(`/ui/`)とOCR API(`/api/ocr`系)を提供し、追加設定なしで相互に通信できること。
- **FR-002**: フロントはデフォルトで同一ドメインのOCR APIを呼び出し、設定値が欠落・不正な場合は利用者に分かるエラー表示を行うこと。
- **FR-003**: ヘルスチェック経由で稼働状況と必要な設定状態（APIキー有無など）を確認できること。
- **FR-004**: 単一のビルド手順でフロントとAPIの成果物が生成・同梱され、追加の手動コピーを不要にすること。
- **FR-005**: デプロイ手順と必要な設定項目（環境変数・配信パスなど）が文書化され、運用者が参照できること。

### Key Entities *(include if feature involves data)*

- **OCRリクエスト**: 利用者がアップロードする画像群、上限ルール、レスポンスメッセージ、処理結果を含む。
- **デプロイ構成**: フロント配信パス、APIエンドポイント、ヘルスチェックの公開パス、必要な設定項目の集合。

## Assumptions

- 既存のフロントエンドは単一ページアプリとして配信され、サブパス(`/ui/`)での配信に対応できる。
- OCR処理はサーバサイドで完結し、クライアント側に機密キーを露出しない。
- 環境変数の設定やデプロイ後のヘルスチェック実行は運用者が行う。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 正常な入力で、フロントからOCR完了までの一連の操作が90%以上成功する。
- **SC-002**: `/ui/` からのリロードや直接アクセスで、主要画面が100%表示される（404にならない）。
- **SC-003**: ヘルスチェックで必要設定の有無を確認し、設定不足があれば100%検知できる。
- **SC-004**: 単一ビルド・単一デプロイ手順でフロントとAPIを同梱でき、追加の手動コピー作業が0回で済む。
