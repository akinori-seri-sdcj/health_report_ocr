# Feature Specification: OCR処理デプロイアーキテクチャの改善

**Feature Branch**: `[001-ocr-deploy-architecture]`  
**Created**: 2025-11-20  
**Status**: Draft  
**Input**: User description: "2b0d0227d8c28083b5f4f46173abbaac.mdに記載されている内容について、OCR処理がエラーなく行われるようデプロイをするためにアーキテクチャを修正・変更を加えてください。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 事務担当者が健康診断結果をOCRで取り込める (Priority: P1)

事務担当者は、健康診断結果の用紙（またはPDF）をシステムにアップロードし、エラーなくOCR処理を実行して結果を確認したい。  
リリースや環境変更の有無に関わらず、毎回同じ手順で問題なく利用できることが重要である。

**Why this priority**: 健康診断結果の取り込みが本機能の主目的であり、日々の事務作業に直結するため。

**Independent Test**: テスト用の健康診断票画像を1件アップロードし、OCR実行ボタンを押して、エラーなく結果が表示されるかを確認する。

**Acceptance Scenarios**:

1. **Given** 事務担当者がログインしている, **When** 健康診断結果ファイルをアップロードしてOCRを実行する, **Then** エラーなくOCR結果が画面に表示される。
2. **Given** システムに新しいバージョンがデプロイされた後, **When** 同じテスト用ファイルでOCRを実行する, **Then** 以前と同様にエラーなく結果が表示される。

---

### User Story 2 - 繰り返し利用してもサービスが安定している (Priority: P2)

事務担当者は、1日に複数回・複数の健康診断結果を連続でOCRにかけても、途中でサービスが落ちたり極端に遅くなったりしないことを期待している。

**Why this priority**: 日常業務では複数のレポートをまとめて処理するケースが多く、安定性が業務効率に直結するため。

**Independent Test**: 複数のテスト用ファイルを用意し、一定時間内に連続してOCRを実行しても、エラーや著しいレスポンス低下が発生しないことを確認する。

**Acceptance Scenarios**:

1. **Given** 通常の業務時間帯, **When** 事務担当者が連続して複数のOCR処理を実行する, **Then** 各処理が完了し、サービスが利用不能になることはない。

---

### User Story 3 - システム管理者がリリース後の稼働状況を確認できる (Priority: P3)

システム管理者は、リリースや設定変更の後に、OCR処理が正しく動いているかを簡単に確認したい。  
問題が発生した場合も、原因が「設定ミスなのか／外部サービス側なのか」など、大まかな切り分けができる状態を望んでいる。

**Why this priority**: リリースや設定変更のたびに「本当に本番で動いているのか？」という不安を減らし、トラブル時の復旧時間を短縮するため。

**Independent Test**: リリース後に用意された確認手順に沿ってテスト用ファイルでOCRを実行し、ステータス表示やエラーメッセージを含めて正常性を確認する。

**Acceptance Scenarios**:

1. **Given** リリースまたは設定変更直後, **When** システム管理者が確認手順に従ってOCRを1件実行する, **Then** 処理結果と稼働状況が問題ないことを確認できる。

---

### Edge Cases

- サービスがメンテナンス中またはバックエンドが停止しているときに、事務担当者がOCRを実行しようとした場合にどう扱うか。
- 入力ファイルサイズが上限を超えた場合に、どのようなエラーメッセージを表示するか。
- 対応していないファイル形式（例：サポート外の画像形式や暗号化PDF）がアップロードされた場合にどう扱うか。
- 一度に多数の利用者が同時にOCRを実行した場合に、処理待ちやタイムアウトをどのように扱うか。
- OCR処理中に外部要因で一時的な障害が発生した場合に、再試行や問い合わせ案内をどのように提示するか。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 事務担当者は、健康診断結果の画像またはPDFをアップロードし、同じ画面からOCR処理を開始できなければならない。
- **FR-002**: システムは、OCR処理を行う専用のバックエンドサービス経由で処理を実行し、利用者からは一貫したインターフェースとして利用できなければならない。
- **FR-003**: システムは、入力ファイルの形式・サイズ・ページ数を検証し、サポート対象外である場合にはその理由を含む分かりやすいエラーメッセージを表示しなければならない。
- **FR-004**: システムは、OCR処理中に障害が発生した場合でもアプリケーション全体が停止せず、ユーザーに再試行の案内や問い合わせ先などの次のアクションを提示しなければならない。
- **FR-005**: システムは、OCR処理の状態（受付中／処理中／完了／エラー）を利用者が認識できる形で画面上に表示しなければならない。
- **FR-006**: システムは、リリース後にOCRサービスの稼働状況を確認できる監視指標や確認手段（例：画面上のステータス表示や確認用の操作手順）が用意されていなければならない。
- **FR-007**: システムは、本番環境にデプロイされた後も設定ミスや接続先の誤りによってOCR処理全体が利用不能にならないよう、環境ごとのOCR関連設定項目が整理され、テスト環境と本番環境で一貫した構成にできなければならない。

### Key Entities *(include if feature involves data)*

- **OCR依頼（リクエスト）**: ユーザーがアップロードした健康診断結果をOCRにかける処理の単位。主な属性は、依頼ID、依頼日時、依頼者、対象ファイル情報（種類・ページ数など）、現在の状態（受付中／処理中／完了／エラー）、エラー内容（あれば）。
- **OCR結果**: OCR依頼に対して出力された文字情報および構造化された結果。主な属性は、対象のOCR依頼ID、抽出された文字列、項目ごとの判定結果（例：数値、判定区分など）、結果生成日時。
- **健康診断レポート**: OCR結果が紐づくビジネス上のレポート単位。主な属性は、レポートID、対象の受診者を識別する情報、受診日、関連するOCR依頼およびOCR結果の参照。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 通常の業務時間帯において、サポート対象の健康診断レポートをアップロードした場合、95%以上のOCR依頼がシステムエラーなく完了すること。
- **SC-002**: サポート対象の単一レポートをアップロードした場合、90%以上のケースで、ユーザーがOCR実行操作を行ってから30秒以内に結果が画面に表示されること。
- **SC-003**: リリース後1か月間に、「OCRがまったく動かない／常にエラーになる」といった種類の問い合わせ件数が、リリース前（直近1か月）と比べて50%以上減少していること。
- **SC-004**: リリース後、業務時間中に10分以上続く「OCRがまったく開始できない状態」が発生しないこと。

## Assumptions

- OCRの対象となる健康診断レポートは、あらかじめ想定されたフォーマットの範囲内で提供される。
- システムの利用者は、社内で定められたネットワーク経由でサービスにアクセスする。
- 1回のOCR依頼では1件の健康診断レポートを処理することを基本とし、複数件の一括処理は別機能として扱う。
