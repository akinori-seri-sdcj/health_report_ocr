# Research and Decisions: OCR結果表示画面の項目番号表示

**Scope**: Resolve all NEEDS CLARIFICATION from plan's Technical Context and finalize choices needed to implement the feature.
**Date**: 2025-11-04

## Decisions

1) UIスタック/テスト基盤/ターゲット/構成
- Decision: 既存プロジェクトのUI/テスト/ターゲット/構成に準拠。新規依存は導入しない。
- Rationale: 影響範囲を最小化し、デプロイ/運用を安定させるため。
- Alternatives considered: 新規UIライブラリ導入（導入コスト/学習コスト増大）、専用E2Eフレームワーク置換（既存資産との互換性が不明）

2) 固定IDのソース（項目定義の識別子）
- Decision: 各表示項目のドメイン定義（内部キー/フィールドコード等）の不変識別子を採用。画面描画時はこのIDをキーに番号マッピングを参照。
- Rationale: 並び替え/フィルタで番号が不変となり、参照の一貫性が保てる。
- Alternatives: 表示順ベースの連番（直感的だが並び替えで変化し混乱を招く）

3) 採番範囲（全体通し）
- Decision: 画面全体で通し番号。隣接タブ/セクション/ページも同一画面内では連続させる。
- Rationale: 一意性・参照の容易さを重視。
- Alternatives: セクションごとリセット（セクション名の併記が必須で複雑化）

4) アクセシビリティ（読み上げ順）
- Decision: 読み上げ順は「番号→ラベル→値」。番号は視覚的に左、読み上げでも先行させる。必要に応じて視覚的には控えめなスタイル（フォント/余白）とする。
- Rationale: 参照の核が番号であるため、先に提示する方が文脈理解しやすい。
- Alternatives: ラベル先行（番号の存在意義が薄れる）

5) CSV列仕様
- Decision: 先頭近傍に `ItemNo` 列を追加。数値（半角）で出力。既存の列順を極力保持しつつ、ラベル/値の直前に配置。
- Rationale: 既存ツールとの互換性を保ちつつ、人が参照しやすい配置。
- Alternatives: 末尾追加（可視性低下）、列名 `Number`（曖昧）

6) PDF表記仕様
- Decision: 項目ラベルの左に番号を表示。ラベル/値との距離は視認性を損なわない最小限の余白。
- Rationale: 画面と同じ見え方を保ち、混乱を避ける。
- Alternatives: 行右端や別列（視線移動が増える）

7) 遅延読み込み/フィルタ/並び替えのフック
- Decision: 画面のデータ更新（差し替え/追記）イベント後に「番号再適用」を呼ぶフックを追加。固定ID→番号のマップを参照するため番号自体は不変。
- Rationale: 非同期UIでも表示崩れ防止。
- Alternatives: 毎回全DOM再計算（コストが高い）、表示順基準の都度採番（仕様に不一致）

8) テスト方針
- Decision: 受け入れシナリオに沿ったE2E（初期表示、スクロール、フィルタ/並び替え、遅延読み込み、アクセシビリティ、エクスポート一致）を最優先。単体/結合テストは採番ロジックとエクスポート整合性に重点。
- Rationale: 本機能の価値はUIでの参照性向上の実体験にあるため。
- Alternatives: 単体中心（UIの崩れを検知しにくい）

## Consolidated Unknowns → Resolutions

- Language/Dependencies/Testing/Target/Project Type → 既存に準拠（新規依存なし）
- 固定IDの取得元 → ドメイン定義の不変識別子を利用
- アクセシビリティ → 番号→ラベル→値、必要なARIA付与
- CSV仕様 → `ItemNo` 列追加（半角数値）、ラベル/値の直前
- PDF仕様 → ラベル左に番号、画面と整合
- イベントフック → データ更新後に番号再適用呼び出し

## Risks & Mitigations

- 既存画面のHTML構造に依存 → 最小限のフックとスタイルで回避、回帰テスト
- 大量項目表示でのレイアウト崩れ → 余白/折返しガイドラインを設けE2Eで確認
- エクスポート系の互換性 → 既存仕様確認とサンプル比較で整合性検証

